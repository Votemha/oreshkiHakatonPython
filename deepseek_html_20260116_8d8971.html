{% extends "layout.html" %}

{% block title %}{{ 'Редактирование' if note else 'Создание' }} заметки - ITMO Notes{% endblock %}

{% block extra_css %}
<style>
    .tag-input {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        min-height: 38px;
    }
    .tag-input .tag {
        margin: 2px;
        cursor: pointer;
    }
    .tag-input .tag:hover {
        background-color: #dc3545;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-white">
                <h2 class="mb-0">{{ 'Редактирование заметки' if note else 'Создание новой заметки' }}</h2>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('edit_note', note_id=note.id if note else None) }}" 
                      enctype="multipart/form-data">
                    
                    <!-- Заголовок -->
                    <div class="mb-4">
                        <label for="title" class="form-label fw-bold">Заголовок *</label>
                        <input type="text" class="form-control form-control-lg" id="title" name="title" 
                               value="{{ note.title if note else '' }}" required maxlength="200" 
                               placeholder="Введите заголовок заметки">
                    </div>
                    
                    <!-- Содержимое -->
                    <div class="mb-4">
                        <label for="content" class="form-label fw-bold">Содержимое *</label>
                        <textarea class="form-control" id="content" name="content" rows="12" 
                                  required placeholder="Текст вашей заметки...">{{ note.content if note else '' }}</textarea>
                        <div class="form-text">
                            Поддерживается Markdown-разметка. Максимум 10,000 символов.
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Категория -->
                        <div class="col-md-6 mb-4">
                            <label for="category" class="form-label fw-bold">Категория</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">Без категории</option>
                                <option value="Учеба" {% if note and note.category == 'Учеба' %}selected{% endif %}>Учеба</option>
                                <option value="Работа" {% if note and note.category == 'Работа' %}selected{% endif %}>Работа</option>
                                <option value="Личное" {% if note and note.category == 'Личное' %}selected{% endif %}>Личное</option>
                                <option value="Проекты" {% if note and note.category == 'Проекты' %}selected{% endif %}>Проекты</option>
                                <option value="Идеи" {% if note and note.category == 'Идеи' %}selected{% endif %}>Идеи</option>
                                <option value="Заметки" {% if note and note.category == 'Заметки' %}selected{% endif %}>Заметки</option>
                            </select>
                        </div>
                        
                        <!-- Видимость -->
                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-bold">Видимость</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="is_public" id="public" 
                                       value="true" {% if note and note.is_public %}checked{% endif %}>
                                <label class="form-check-label" for="public">
                                    <i class="bi bi-globe"></i> Публичная (видят все пользователи)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="is_public" id="private" 
                                       value="false" {% if not note or not note.is_public %}checked{% endif %}>
                                <label class="form-check-label" for="private">
                                    <i class="bi bi-lock"></i> Приватная (только для меня)
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Теги -->
                    <div class="mb-4">
                        <label for="tags" class="form-label fw-bold">Теги</label>
                        <input type="text" class="form-control" id="tags" name="tags" 
                               value="{{ note.tags if note else '' }}" 
                               placeholder="Введите теги через запятую (например: python, алгоритмы, учеба)">
                        <div class="form-text">
                            Можно добавить до 10 тегов, разделяя их запятыми
                        </div>
                    </div>
                    
                    <!-- Загрузка файлов -->
                    <div class="mb-4">
                        <label for="attachments" class="form-label fw-bold">Прикрепленные файлы</label>
                        
                        {% if note and attachments %}
                        <div class="mb-3">
                            <h6>Существующие файлы:</h6>
                            <div class="list-group">
                                {% for attachment in attachments %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-file-earmark me-2"></i>
                                        {{ attachment.filename }}
                                        <small class="text-muted d-block">{{ attachment.file_size }} KB</small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="delete_files[]" value="{{ attachment.id }}" 
                                               id="delete_{{ attachment.id }}">
                                        <label class="form-check-label text-danger" for="delete_{{ attachment.id }}">
                                            Удалить
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Новые файлы -->
                        <div class="mb-3">
                            <label class="form-label">Добавить новые файлы:</label>
                            <input type="file" class="form-control" id="attachments" name="attachments" 
                                   multiple accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                            <div class="form-text">
                                Можно загрузить несколько файлов. Максимальный размер каждого файла: 5MB.
                                Поддерживаемые форматы: txt, pdf, doc, docx, jpg, png, gif.
                            </div>
                            <div id="file-preview" class="mt-2 text-muted"></div>
                        </div>
                    </div>
                    
                    <!-- Кнопки -->
                    <div class="d-flex justify-content-between pt-3 border-top">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            Отмена
                        </a>
                        <div>
                            {% if note %}
                            <a href="{{ url_for('view_note', note_id=note.id) }}" class="btn btn-outline-primary me-2">
                                Просмотр
                            </a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save"></i> {{ 'Сохранить изменения' if note else 'Создать заметку' }}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Превью файлов
    document.getElementById('attachments').addEventListener('change', function() {
        const preview = document.getElementById('file-preview');
        const files = this.files;
        
        if (files.length > 0) {
            let fileList = 'Выбрано файлов: ' + files.length + '<br>';
            for (let i = 0; i < Math.min(files.length, 3); i++) {
                fileList += '• ' + files[i].name + ' (' + (files[i].size / 1024).toFixed(1) + ' KB)<br>';
            }
            if (files.length > 3) {
                fileList += '• ... и ещё ' + (files.length - 3) + ' файлов';
            }
            preview.innerHTML = fileList;
        } else {
            preview.innerHTML = '';
        }
    });
    
    // Счетчик символов для контента
    const contentTextarea = document.getElementById('content');
    const counter = document.createElement('div');
    counter.className = 'form-text text-end';
    contentTextarea.parentNode.appendChild(counter);
    
    function updateCounter() {
        const length = contentTextarea.value.length;
        counter.textContent = length + ' / 10000 символов';
        if (length > 10000) {
            counter.classList.add('text-danger');
        } else {
            counter.classList.remove('text-danger');
        }
    }
    
    contentTextarea.addEventListener('input', updateCounter);
    updateCounter();
</script>
{% endblock %}
{% endblock %}